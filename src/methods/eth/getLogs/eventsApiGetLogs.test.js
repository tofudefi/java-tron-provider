import test from "ava";
// import * as eth_ from "../index.js";
import eventsApiGetLogs_ from "./eventsApiGetLogs.js";
import autoRety from "../../autoRetry.js";
import { numberToHex } from "../../utils/index.js";
import { createContext } from "../../../index.js";

const eventsApiGetLogs = autoRety(eventsApiGetLogs_);

const context = createContext({ network: "nile" });

const expectedLogs = [
  {
    address: "0x29bba2cb5a76b3f49d12928e7dcc79db7d8ebc6d",
    blockNumber: "0x82e0e4",
    blockHash:
      "0x000000000082e0e4a34a0899c4e86f68f9be9ae9ae01065b92de0c01d9af2c51",
    data:
      "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000039e63f8d70becdaba64a45091688a8446d57689000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000044361726c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002968747470733a2f2f74686567726170682e636f6d2f696d672f7465616d2f7465616d5f30342e706e670000000000000000000000000000000000000000000000",
    // logIndex: '0x0',
    removed: false,
    topics: [
      "0x9ab3aefb2ba6dc12910ac1bce4692cf5c3c0d06cff16327c64a3ef78228b130b",
    ],
    transactionHash:
      "0x62f8dad342102a19150b5e8c61abfe0468b4ab092193f1b6af9270af800f38c9",
    // transactionIndex: '0x0'
  },
  {
    address: "0x8f89f6abe23ab1a7706f8825519b7192a02ed7a8",
    blockNumber: "0x82e12c",
    blockHash:
      "0x000000000082e12c6be47957d423e42fd616a7f2c442e63200c84f462b418de8",
    data:
      "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000418178358",
    // logIndex: '0x1',
    removed: false,
    topics: [
      "0x1817835800000000000000000000000000000000000000000000000000000000",
      "0x00000000000000000000000006ed1bbcdf7381dda0523ffabdefd8880bbd9182",
      "0x0000000000000000000000000000000000000000000000000000000000000000",
      "0x0000000000000000000000000000000000000000000000000000000000000000",
    ],
    transactionHash:
      "0x78f45605d2cbb1a3a30646b1c66bc33148a0f2bb4d3b0095a458d8f5bd9dd42f",
    // transactionIndex: '0x1'
  },
  {
    address: "0x06ed1bbcdf7381dda0523ffabdefd8880bbd9182",
    blockNumber: "0x82e12c",
    blockHash:
      "0x000000000082e12c6be47957d423e42fd616a7f2c442e63200c84f462b418de8",
    data:
      "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000645a68669900000000000000000000000000000000000000000000000000514599cde1c000000000000000000000000000000000000000000000000000000000005f5153740000000000000000000000418f89f6abe23ab1a7706f8825519b7192a02ed7a8",
    // logIndex: '0x2',
    removed: false,
    topics: [
      "0x5a68669900000000000000000000000000000000000000000000000000000000",
      "0x00000000000000000000000065fa68800fff5a10346d1a3aa1fb2ce92f2e2971",
      "0x00000000000000000000000000000000000000000000000000514599cde1c000",
      "0x000000000000000000000000000000000000000000000000000000005f515374",
    ],
    transactionHash:
      "0x78f45605d2cbb1a3a30646b1c66bc33148a0f2bb4d3b0095a458d8f5bd9dd42f",
    // transactionIndex: '0x2'
  },
];

test("eth_getLogs (events api)", async (t) => {
  // https://event.nileex.io/contractlogs?limit=200&start=1&sort=timeStamp&block=8577252
  const res = await eventsApiGetLogs(
    [
      {
        fromBlock: numberToHex(8577252),
        toBlock: numberToHex(8577324),
      },
    ],
    context
  );

  // TODO: use ava snapshot testing...
  t.is(res.length, 3);
  res.forEach((log, idx) => {
    t.like(log, expectedLogs[idx]);
  });
});

test("eth_getLogs (events api) topics filter", async (t) => {
  const res = await eventsApiGetLogs(
    [
      {
        fromBlock: numberToHex(8577252),
        toBlock: numberToHex(8577324),
        topics: [
          null,
          "0x00000000000000000000000006ed1bbcdf7381dda0523ffabdefd8880bbd9182",
        ],
      },
    ],
    context
  );

  // TODO: use ava snapshot testing...
  t.is(res.length, 1);
  t.like(res[0], expectedLogs[1]);
});

test("eth_getLogs (events api) contract filter", async (t) => {
  const res = await eventsApiGetLogs(
    [
      {
        address: "0x29Bba2CB5a76b3F49D12928E7dCc79DB7D8Ebc6D",
      },
    ],
    context
  );

  // TODO: use ava snapshot testing...
  t.true(res.length >= 2);
  t.deepEqual(
    [res[0], res[1]],
    [
      {
        address: "0x29bba2cb5a76b3f49d12928e7dcc79db7d8ebc6d",
        blockNumber: "0x82e0e4",
        blockHash:
          "0x000000000082e0e4a34a0899c4e86f68f9be9ae9ae01065b92de0c01d9af2c51",
        data:
          "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000039e63f8d70becdaba64a45091688a8446d57689000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000044361726c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002968747470733a2f2f74686567726170682e636f6d2f696d672f7465616d2f7465616d5f30342e706e670000000000000000000000000000000000000000000000",
        logIndex: "0x0",
        removed: false,
        topics: [
          "0x9ab3aefb2ba6dc12910ac1bce4692cf5c3c0d06cff16327c64a3ef78228b130b",
        ],
        transactionHash:
          "0x62f8dad342102a19150b5e8c61abfe0468b4ab092193f1b6af9270af800f38c9",
        transactionIndex: "0x0",
      },
      {
        address: "0x29bba2cb5a76b3f49d12928e7dcc79db7d8ebc6d",
        blockNumber: "0x82e54f",
        blockHash:
          "0x000000000082e54f4f82bfd05adc7adf8984f367ffe02be0d295529dd749d72f",
        data:
          "0x000000000000000000000000000000000000000000000000000000000000000100000000000000000000000022e1c389f64fbb973169053c40396f7f2d51b15a000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000b616c6963652d3078323265000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c687474703a2f2f696d6775722e636f6d2f616c6963652d307832326500000000",
        logIndex: "0x1",
        removed: false,
        topics: [
          "0x9ab3aefb2ba6dc12910ac1bce4692cf5c3c0d06cff16327c64a3ef78228b130b",
        ],
        transactionHash:
          "0xf08d6cebe53cae8eb8838e315ddaf5dd4a64d83d7e9ee0a36a7a53d79bcb9a61",
        transactionIndex: "0x1",
      },
    ]
  );
});
